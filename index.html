<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ÈÅÅÁî≤ÂΩí‰∏Ä V12 ¬∑ Áâ©ÁêÜÂÖ®ÊÅØÊäïÂΩ±</title>
    <style>
        :root { 
            --gold: #f1c40f; --cyan: #00e5ff; --red: #ff3366; 
            --font-main: "Noto Serif SC", "KaiTi", serif;
            --font-mono: "JetBrains Mono", Consolas, monospace;
            --panel-bg: rgba(15, 15, 18, 0.90);
        }
        body { 
            background: radial-gradient(circle at center, #080808 0%, #000 100%); 
            color: #fff; font-family: var(--font-main); margin: 0; 
            height: 100vh; overflow: hidden; display: flex; 
            flex-direction: column; align-items: center; position: relative;
        }

        /* === 1. È°∂ÈÉ®ÂèåÂ±ÇÊÇ¨ÊµÆÂå∫ === */
        #top-container {
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            z-index: 500; width: fit-content;
        }

        /* Ê†áÈ¢òÊ†è */
        .title-bar {
            background: rgba(20, 20, 20, 0.85);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 50px; padding: 5px 45px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
        }
        .brand {
            font-size: 22px; color: var(--gold); font-weight: bold; 
            letter-spacing: 6px; text-shadow: 0 0 12px rgba(241, 196, 15, 0.5);
            font-family: "KaiTi"; margin-right: -6px;
        }

        /* ÊéßÂà∂Ê†è */
        .ctrl-bar {
            background: rgba(30, 30, 30, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 50px; padding: 5px 20px;
            backdrop-filter: blur(8px);
            display: flex; gap: 10px; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* ËæìÂÖ•Ê°Ü */
        input { 
            background: rgba(0,0,0,0.4); border: 1px solid #444; 
            color: #ddd; padding: 2px 8px; border-radius: 4px; 
            font-family: sans-serif; font-size: 13px; text-align: center; height: 24px;
        }
        input:focus { outline: 1px solid var(--gold); background: #000; }
        .lbl-mini { color: #888; font-size: 11px; font-family: sans-serif; margin-right: -5px; white-space: nowrap;}

        /* ÊåâÈíÆ (‰øÆÂ§ç‰∏≤Ë°åÈóÆÈ¢ò) */
        button { 
            background: linear-gradient(135deg, #f1c40f, #b8860b); color: #000;
            border: none; padding: 0 15px; border-radius: 12px; height: 28px;
            font-weight: bold; cursor: pointer; font-size: 12px;
            transition: all 0.2s; box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2);
            
            /* ÂÖ≥ÈîÆ‰øÆÂ§ç‰ª£Á†Å */
            white-space: nowrap; /* Âº∫Âà∂‰∏çÊç¢Ë°å */
            flex-shrink: 0;      /* Á¶ÅÊ≠¢Ë¢´ÂéãÁº© */
            display: flex; align-items: center; justify-content: center;
            min-width: 60px;
        }
        button:hover { transform: scale(1.05); filter: brightness(1.1); }
        button.secondary { background: #444; color: #ccc; box-shadow: none; min-width: 30px; }

        /* === 2. Â∑¶‰æß‰æßËæπÊ†è (ÊûÅÁÆÄ) === */
        .info-sidebar { 
            position: absolute; left: 20px; top: 110px; bottom: 30px; width: 190px;
            display: flex; flex-direction: column; justify-content: center; pointer-events: none; 
        }
        .sidebar-panel {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left: 3px solid var(--gold); border-radius: 8px; padding: 15px;
            pointer-events: auto; backdrop-filter: blur(10px);
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 8px 0 25px rgba(0,0,0,0.6);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .info-sidebar.hidden .sidebar-panel { transform: translateX(-240px); }
        .toggle-btn {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 24px; height: 50px; margin-left: -24px;
            background: var(--gold); border-radius: 0 6px 6px 0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; pointer-events: auto; font-size: 12px; color: #000; 
            opacity: 0; transition: opacity 0.3s;
        }
        .info-sidebar.hidden .toggle-btn { opacity: 1; left: 0; margin-left: 0; }
        
        .sb-block { display: flex; flex-direction: column; gap: 3px; }
        .block-title { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 3px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .row-compact { display: flex; justify-content: space-between; font-size: 11px; line-height: 1.5; }
        .c-lbl { color: #999; } .c-val { color: #ddd; font-family: var(--font-mono); }
        .big-txt { font-size: 14px; color: var(--gold); text-align: center; font-weight: bold; margin: 4px 0; letter-spacing: 1px; }
        .hl-txt { color: var(--cyan); } .warn { color: var(--red); }
        .panel-close { position: absolute; right: 8px; top: 5px; color: #555; cursor: pointer; font-size: 12px; }
        .panel-close:hover { color: #fff; }

        /* === 3. ÂÆáÂÆôËßÜÁïå === */
        .universe { 
            position: absolute; top: 52%; left: 52%; transform: translate(-50%, -50%);
            width: 700px; height: 700px; 
            perspective: 1000px; transform-style: preserve-3d; z-index: 1;
        }
        :root { --view-angle: 20deg; }

        /* ÊòüÂÆøÁéØ (850pxÔºåÂÆåÂÖ®ÈÄÇÈÖç) */
        .mansion-ring { 
            position: absolute; top: 50%; left: 50%; width: 850px; height: 850px; 
            margin-left: -425px; margin-top: -425px; 
            border: 1px dashed rgba(255, 255, 255, 0.08); border-radius: 50%; 
            transform: rotateX(var(--view-angle)) translateZ(-450px); 
            animation: slow-spin 400s linear infinite; pointer-events: none;
        }
        @keyframes slow-spin { from { transform: rotateX(var(--view-angle)) translateZ(-450px) rotateZ(0deg); } to { transform: rotateX(var(--view-angle)) translateZ(-450px) rotateZ(360deg); } }
        .xiu { position: absolute; top: 50%; left: 50%; font-size: 16px; font-weight: bold; color: rgba(241, 196, 15, 0.35); transform-origin: center; font-family: "KaiTi"; }

        /* ÂåóÊñóÂ±Ç */
        .sky-layer { 
            position: absolute; top: 50%; left: 50%; width: 650px; height: 650px; 
            margin-left: -325px; margin-top: -325px; 
            transform: rotateX(var(--view-angle)) translateZ(-220px); 
            transition: transform 1.5s ease-out; pointer-events: none; transform-style: preserve-3d;
        }
        .star { position: absolute; transform: translate(-50%, -50%); background: #fff; border-radius: 50%; box-shadow: 0 0 5px 2px #fff; }
        .star.main { width: 7px; height: 7px; animation: pulse 3s infinite alternate; } 
        .star.hidden { width: 4px; height: 4px; opacity: 0.4; }
        .dipper-lines polyline { fill: none; stroke: rgba(255, 255, 255, 0.3); stroke-width: 1.5; stroke-dasharray: 4, 4; }
        @keyframes pulse { from { opacity: 0.7; transform: translate(-50%, -50%) scale(1); } to { opacity: 1; transform: translate(-50%, -50%) scale(1.3); } }

        /* ‰πùÂÆ´Ê†º */
        .earth-layer { 
            position: absolute; top: 50%; left: 50%; width: 480px; height: 480px; 
            margin-left: -240px; margin-top: -240px; 
            transform: rotateX(var(--view-angle)) translateZ(0px); 
            transform-style: preserve-3d; 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; z-index: 50;
        }
        .grid-cell { 
            background: rgba(20, 25, 30, 0.85); border: 1px solid rgba(212, 175, 55, 0.3); 
            display: flex; flex-direction: column; justify-content: space-between; padding: 8px;
            backdrop-filter: blur(5px); transition: all 0.3s;
        }
        .grid-cell:hover { border-color: var(--gold); background: rgba(40, 50, 70, 0.95); transform: translateZ(30px) scale(1.05); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .grid-cell.highlight { border-color: var(--gold); background: rgba(212, 175, 55, 0.15); box-shadow: inset 0 0 15px rgba(212, 175, 55, 0.2); }

        .god { font-size: 11px; color: #ff5555; text-shadow: 0 0 5px #aa0000; }
        .stem-t { font-size: 15px; color: var(--gold); font-weight: bold; }
        .star-n { font-size: 22px; color: #fff; font-weight: bold; font-family: "KaiTi"; text-shadow: 0 0 8px rgba(255,255,255,0.7); }
        .star-a { font-size: 8px; color: #777; text-transform: uppercase; display: block; margin-top:-2px; letter-spacing: 0.5px;}
        .stem-d { font-size: 15px; color: #2ecc71; font-weight: bold; }
        .door { font-size: 14px; color: var(--cyan); font-weight: bold; }
        .door.empty { color: #555; }
        .row-top, .row-bot { display: flex; justify-content: space-between; align-items: center; }
        .row-mid { text-align: center; }

    </style>
</head>
<body>

    <div id="top-container">
        <div class="title-bar">
            <div class="brand">ÈÅÅÁî≤ÂΩí‰∏Ä V12</div>
        </div>

        <div class="ctrl-bar">
            <button class="secondary" onclick="setNow()">‚Ü∫</button>
            <input type="datetime-local" id="in-time" step="1">
            
            <span style="color:#444">|</span>
            
            <span class="lbl-mini">LON</span>
            <input type="text" id="in-lon" value="120.00" style="width:50px">
            
            <span class="lbl-mini">LAT</span>
            <input type="text" id="in-lat" value="30.00" style="width:50px">
            
            <button class="secondary" onclick="autoLocate()">üìç</button>
            <button onclick="refreshData()">‚ö° Êºî ÁÆó</button>
        </div>
    </div>

    <div class="info-sidebar" id="sidebar">
        <div class="sidebar-panel">
            <div class="panel-close" onclick="toggleSidebar()" title="Êî∂Ëµ∑">‚úï</div>
            
            <div class="sb-block">
                <div class="block-title">CALENDAR</div>
                <div class="row-compact"><span class="c-lbl">Èò≥ÂéÜ</span><span class="c-val" id="t-greg">--</span></div>
                <div class="row-compact"><span class="c-lbl">ÂÜúÂéÜ</span><span class="c-val" id="t-lunar">--</span></div>
                <div class="big-txt" id="t-ganzhi">-- -- -- --</div>
            </div>

            <div class="sb-block">
                <div class="block-title">LOCATION</div>
                <div class="row-compact"><span class="c-lbl">ÂùêÊ†á</span><span class="c-val" id="p-coord">--</span></div>
                <div class="row-compact"><span class="c-lbl">Ê∞îÂú∫</span><span class="c-val" id="p-hemi">--</span></div>
                <div class="row-compact"><span class="c-lbl">Êó∂Â∑Æ</span><span class="c-val" id="p-eot">--</span></div>
            </div>

            <div class="sb-block">
                <div class="block-title">STRUCTURE</div>
                <div class="row-compact"><span class="c-lbl">ÂÆöÂ±Ä</span><span class="c-val hl-txt" id="p-ju">--</span></div>
                <div class="row-compact"><span class="c-lbl">ÊúàÂ∞Ü</span><span class="c-val" id="p-jiang">--</span></div>
                <div class="row-compact"><span class="c-lbl">Êó•Á©∫</span><span class="c-val" id="p-kong">--</span></div>
            </div>

            <div class="sb-block">
                <div class="block-title">LEADERS</div>
                <div class="row-compact"><span class="c-lbl">ÂÄºÁ¨¶</span><span class="c-val" style="color:var(--gold)" id="v-star">--</span></div>
                <div class="row-compact"><span class="c-lbl">ÂÄº‰Ωø</span><span class="c-val" style="color:var(--cyan)" id="v-door">--</span></div>
                <div class="row-compact"><span class="c-lbl">ÊñóÊùì</span><span class="c-val" id="v-angle">--</span></div>
            </div>
            
            <div class="sb-block" style="margin-top:5px; opacity:0.4; text-align:center;">
                <span style="font-size:9px;">Physics V12 Core</span>
            </div>
        </div>
        <div class="toggle-btn" onclick="toggleSidebar()">‚ñ∂</div>
    </div>

    <div class="universe">
        <div class="mansion-ring" id="ring"></div>
        <div class="sky-layer" id="dipper">
            <svg class="dipper-lines" style="position:absolute; width:100%; height:100%; overflow:visible;">
                <polyline id="line-poly" points=""></polyline>
            </svg>
        </div>
        <div class="earth-layer" id="grid"></div>
    </div>

    <script>
        const MANSIONS = ["Ëßí","‰∫¢","Ê∞ê","Êàø","ÂøÉ","Â∞æ","ÁÆï","Êñó","Áâõ","Â•≥","Ëôö","Âç±","ÂÆ§","Â£Å","Â•é","Â®Ñ","ËÉÉ","Êò¥","ÊØï","ÂèÇ","Ëßú","‰∫ï","È¨º","Êü≥","Êòü","Âº†","Áøº","ËΩ∏"];
        const GRID_ORDER = [4, 9, 2, 3, 5, 7, 8, 1, 6];
        const DIPPER_STARS = [
            { id: 1, x: 55, y: 40 }, { id: 2, x: 63, y: 43 },
            { id: 3, x: 60, y: 50 }, { id: 4, x: 52, y: 52 },
            { id: 5, x: 42, y: 55 }, { id: 6, x: 32, y: 52 },
            { id: 7, x: 20, y: 45 },
            { id: 8, x: 34, y: 49, hidden: true }, { id: 9, x: 28, y: 54, hidden: true }
        ];
        const LINE_PATH = [7, 6, 5, 4, 3, 2, 1, 4];

        function init() {
            const ring = document.getElementById('ring');
            MANSIONS.forEach((n, i) => {
                const el = document.createElement('div'); el.innerText = n; el.className = 'xiu';
                // ÂÆåÁæéÂçäÂæÑÔºö425px
                const r = 425; 
                const rad = ((i/28)*360 - 90) * (Math.PI/180);
                el.style.left = (r * Math.cos(rad) + 425) + 'px'; 
                el.style.top = (r * Math.sin(rad) + 425) + 'px';
                el.style.transform = `translate(-50%, -50%) rotate(${i/28*360}deg)`;
                ring.appendChild(el);
            });
            renderDipper();
            setNow();
            refreshData();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden');
        }

        function renderDipper() {
            const container = document.getElementById('dipper');
            const polyline = document.getElementById('line-poly');
            const w = 650; const h = 650;
            let pointsStr = "";
            const starMap = {};
            DIPPER_STARS.forEach(star => {
                const px = (star.x / 100) * w; const py = (star.y / 100) * h;
                starMap[star.id] = {x: px, y: py};
                const el = document.createElement('div');
                el.className = star.hidden ? 'star hidden' : 'star main';
                el.style.left = star.x + '%'; el.style.top = star.y + '%';
                container.appendChild(el);
            });
            LINE_PATH.forEach(id => {
                const p = starMap[id]; if(p) pointsStr += `${p.x},${p.y} `;
            });
            polyline.setAttribute('points', pointsStr.trim());
        }

        function setNow() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            document.getElementById('in-time').value = (new Date(now - offset)).toISOString().slice(0, 16);
        }

        function autoLocate() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('in-lat').value = pos.coords.latitude.toFixed(2);
                    document.getElementById('in-lon').value = pos.coords.longitude.toFixed(2);
                    refreshData();
                }, () => alert("ÂÆö‰ΩçÂ§±Ë¥•"));
            } else { alert("Êó†ÊùÉÈôê"); }
        }

        function toDMS(deg, isLat) {
            const val = Math.abs(deg);
            const d = Math.floor(val);
            const m = Math.floor((val - d) * 60);
            return `${d}¬∞${m}'${isLat ? (deg>=0?"N":"S") : (deg>=0?"E":"W")}`;
        }

        async function refreshData() {
            const t = document.getElementById('in-time').value;
            const lon = document.getElementById('in-lon').value;
            const lat = document.getElementById('in-lat').value;
            
            try {
                const res = await fetch(`http://localhost:8000/api/state?time=${t}&lon=${lon}&lat=${lat}`);
                if (!res.ok) throw new Error("Server Error");
                const data = await res.json();
                const cal = data.calendar; const lead = data.leaders; const phy = data.physics;

                // ‰æßËæπÊ†è
                document.getElementById('t-greg').innerText = cal.gregorian.split(' ')[0];
                document.getElementById('t-lunar').innerText = cal.lunar;
                document.getElementById('t-ganzhi').innerText = cal.ganzhi;
                
                const latVal = parseFloat(phy.location?.lat || lat);
                const lonVal = parseFloat(phy.location?.lon || lon);
                document.getElementById('p-coord').innerHTML = `${toDMS(latVal, true)}<br>${toDMS(lonVal, false)}`;
                
                const isSouth = phy.hemisphere === 'South';
                const hEl = document.getElementById('p-hemi');
                hEl.innerText = isSouth ? "Âçó (Ê∞îÂèç)" : "Âåó (Ê≠£Ê∞î)";
                hEl.className = isSouth ? "c-val warn" : "c-val hl-txt";

                document.getElementById('p-eot').innerText = phy.eot;
                document.getElementById('p-ju').innerText = lead.ju;
                document.getElementById('p-jiang').innerText = lead.jiang;
                document.getElementById('p-kong').innerText = cal.kongwang;
                document.getElementById('v-star').innerText = lead.zhifu;
                document.getElementById('v-door').innerText = lead.zhishi;
                document.getElementById('v-angle').innerText = (phy.dubhe_angle||0).toFixed(1) + "¬∞";

                // Âä®Áîª
                document.getElementById('dipper').style.transform = `rotateX(20deg) translateZ(-220px) rotateZ(${phy.dubhe_angle||0}deg)`;

                // Ê∏≤Êüì
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                GRID_ORDER.forEach(pos => {
                    const cell = data.grid[pos];
                    const div = document.createElement('div');
                    div.className = 'grid-cell' + (pos==5 ? ' highlight' : '');
                    const isEmp = !cell.door.name || cell.door.name=='Á©∫';
                    div.innerHTML = `
                        <div class="row-top">
                            <span class="god">${cell.god.name}</span>
                            <span class="stem-t">${cell.stems.heaven||''}</span>
                        </div>
                        <div class="row-mid">
                            <span class="star-n">${cell.star.name}</span>
                            <span class="star-a">${cell.star.astro||''}</span>
                        </div>
                        <div class="row-bot">
                            <span class="stem-d">${cell.stems.earth||''}</span>
                            <span class="${isEmp?'door empty':'door'}">${isEmp?'Á©∫':cell.door.name}</span>
                        </div>
                    `;
                    grid.appendChild(div);
                });

            } catch (e) { console.error(e); }
        }

        init();
        setInterval(refreshData, 10000);
    </script>
</body>
</html>